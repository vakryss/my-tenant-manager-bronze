<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard â€“ My Tenant Manager</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ===============================
       HARD BLOCK RENDER (NO FLASH)
  =============================== -->
  <style>
    html {
      visibility: hidden;
    }
  </style>

  <!-- ===============================
       AUTH GATE (BEFORE PAINT)
  =============================== -->
  <script type="module">
    import { supabase } from "./scripts/supabase.js";

    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.replace("/login.html");
    } else {
      document.documentElement.style.visibility = "visible";
    }
  </script>

  <!-- ===============================
       BASE UI STYLES (MOBILE-FIRST)
  =============================== -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fb;
      color: #1a1a1a;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    p {
      margin: 4px 0 12px;
      font-size: 0.9rem;
      color: #555;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .field {
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .field strong {
      display: inline-block;
      width: 110px;
    }

    input {
      width: 100%;
      padding: 10px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      font-size: 0.95rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.danger {
      background: #dc2626;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .message {
      font-size: 0.85rem;
      margin-top: 8px;
    }

    /* ===============================
       TABLET
    =============================== */
    @media (min-width: 600px) {
      .nav-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ===============================
       DESKTOP
    =============================== */
    @media (min-width: 900px) {
      .nav-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>
</head>

<body>

  <div class="container">

    <!-- ===============================
         HEADER
    =============================== -->
    <h1>My Tenant Manager</h1>
    <p>Bronze Tier Dashboard</p>

    <!-- ===============================
         PROFILE CARD
    =============================== -->
    <div class="card">
      <h2>Landlord Profile</h2>

      <div class="field">
        <strong>Email:</strong>
        <span id="profileEmail">N/A</span>
      </div>

      <div class="field">
        <strong>Country:</strong>
        <span id="profileCountry">N/A</span>
      </div>

      <div class="field">
        <strong>Currency:</strong>
        <span id="profileCurrency">N/A</span>
      </div>

      <div class="field">
        <strong>Full Name:</strong>
        <span id="profileFullName">N/A</span>
      </div>
    </div>

    <!-- ===============================
         EDIT PROFILE
    =============================== -->
    <div class="card">
      <h2>Edit Profile</h2>

      <label for="fullNameInput">Full Name</label>
      <input id="fullNameInput" type="text">

      <button id="saveProfileBtn">Save Profile</button>
      <div id="profileMessage" class="message">N/A</div>
    </div>

    <!-- ===============================
         NAVIGATION
    =============================== -->
    <div class="card">
      <h2>Manage</h2>

      <div class="nav-grid">
        <button onclick="location.href='/tenants.html'">Tenants</button>
        <button onclick="location.href='/rent.html'">Rent</button>
        <button onclick="location.href='/utilities.html'">Utilities</button>
        <button onclick="location.href='/payments.html'">Payments</button>
        <button onclick="location.href='/ledger.html'">General Ledger</button>
        <button onclick="location.href='/tenant-ledger.html'">Tenant Ledger</button>
      </div>
    </div>

    <!-- ===============================
         SYSTEM ACTIONS
    =============================== -->
    <div class="card">
      <button id="logoutBtn" class="danger">Logout</button>
    </div>

  </div>

  <!-- ===============================
       PAGE LOGIC
  =============================== -->
  <script type="module">
    import { supabase } from "./scripts/supabase.js";
    import { logout } from "./scripts/session.js";

    async function loadProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from("users_profile")
        .select("email, country, currency_code, currency_symbol, full_name")
        .eq("id", user.id)
        .single();

      if (error) return;

      document.getElementById("profileEmail").textContent =
        data.email || "N/A";

      document.getElementById("profileCountry").textContent =
        data.country || "N/A";

      document.getElementById("profileCurrency").textContent =
        `${data.currency_symbol} (${data.currency_code})`;

      document.getElementById("profileFullName").textContent =
        data.full_name || "N/A";

      document.getElementById("fullNameInput").value =
        data.full_name || "";
    }

    async function updateProfile() {
      const message = document.getElementById("profileMessage");
      const fullName = document.getElementById("fullNameInput").value.trim();

      message.textContent = "Saving...";

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        message.textContent = "Not authenticated.";
        return;
      }

      const { error } = await supabase
        .from("users_profile")
        .update({ full_name: fullName || "N/A" })
        .eq("id", user.id);

      if (error) {
        message.textContent = error.message;
        return;
      }

      message.textContent = "Profile updated.";
      loadProfile();
    }

    document
      .getElementById("saveProfileBtn")
      .addEventListener("click", updateProfile);

    document
      .getElementById("logoutBtn")
      .addEventListener("click", logout);

    loadProfile();
  </script>

</body>
</html>
